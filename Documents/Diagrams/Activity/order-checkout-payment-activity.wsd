@startuml order-checkout-payment-activity
skinparam linetype spline
title Order Checkout and Payment Activity Diagram

|User|
start
:Access Shopping Cart;
:Review Cart Items;

repeat
  if (Want to Modify Cart?) then (yes)
    if (Remove Item?) then (yes)
      :Select Item to Remove;
      :Confirm Removal;
      
      |System|
      :Remove Item from Cart;
      :Update Cart Total;
    else (no)
      :Update Item Quantity;
      :Change Quantity;
      
      |System|
      :Validate Stock Availability;
      if (Sufficient Stock?) then (yes)
        :Update Cart Item;
        :Recalculate Total;
      else (no)
        :Show Stock Error;
        :Revert to Available Stock;
      endif
    endif
  endif
repeat while (Continue Modifying?)

if (Cart Not Empty?) then (yes)
  :Proceed to Checkout;
  :Review Order Summary;
  :Confirm Order Details;
  
  |System|
  :Generate Order ID;
  :Calculate Total Amount;
  :Check Stock Availability;
  
  if (All Items Available?) then (yes)
    :Reserve Stock;
    :Create Order Record;
    :Set Status to Pending;
    
    |User|
    :Select Payment Method;
    :Enter Payment Details;
    :Submit Payment;
    
    |System|
    :Process Payment;
    :Validate Payment Information;
    
    if (Payment Successful?) then (yes)
      :Update Payment Status to Completed;
      :Update Order Status to Confirmed;
      :Reduce Drug Stock;
      :Clear User Cart;
      :Send Order Confirmation Email;
      
      |User|
      :Receive Order Confirmation;
      :View Order Details;
      :Track Order Status;
    else (no)
      :Payment Failed;
      :Restore Reserved Stock;
      :Update Payment Status to Failed;
      :Update Order Status to Cancelled;
      :Show Payment Error;
      
      if (Retry Payment?) then (yes)
        :Try Different Payment Method;
      else (no)
        :Cancel Order;
        stop
      endif
    endif
  else (no)
    :Show Stock Unavailable;
    :Update Cart with Available Items;
    :Return to Cart;
  endif
else (no)
  :Empty Cart Message;
  :Return to Shopping;
endif

stop
@enduml
