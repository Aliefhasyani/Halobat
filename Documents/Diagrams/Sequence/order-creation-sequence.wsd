@startuml order-creation-sequence
title Order Creation Sequence Diagram

actor User
participant "Checkout\nPage" as CheckoutUI
participant "Order\nController" as OrderController
participant "Order\nModel" as OrderModel
participant "OrderItem\nModel" as OrderItemModel
participant "Drug\nModel" as DrugModel
participant "Database" as DB

note left: Continues from cart-validation-checkout-sequence

User -> CheckoutUI: Confirm order
CheckoutUI -> OrderController: createOrder(userId, cartItems)

OrderController -> OrderModel: createOrder(userId, totalAmount)
OrderModel -> DB: INSERT INTO orders (user_id, total_amount, status)
DB --> OrderModel: Order created
OrderModel --> OrderController: Order ID

loop For each cart item
    OrderController -> OrderItemModel: createOrderItem(orderId, drugId, quantity, price)
    OrderItemModel -> DB: INSERT INTO order_items (order_id, drug_id, quantity, price)
    DB --> OrderItemModel: Order item created
    OrderItemModel --> OrderController: Item added
    
    OrderController -> DrugModel: reserveStock(drugId, quantity)
    DrugModel -> DB: UPDATE drugs SET stock = stock - ? WHERE id=?
    DB --> DrugModel: Stock reserved
    DrugModel --> OrderController: Stock updated
end

OrderController --> CheckoutUI: Order created successfully
CheckoutUI --> User: Show payment options

note right: Flow continues to payment-processing-sequence

@enduml
