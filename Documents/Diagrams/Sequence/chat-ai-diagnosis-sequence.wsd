@startuml chat-ai-diagnosis-sequence
title Chat with AI and Diagnosis Creation Sequence Diagram

actor User
participant "Chat\nInterface" as ChatUI
participant "Chat\nController" as ChatController
participant "LLM\nService" as LLM
participant "Diagnosis\nModel" as DiagnosisModel
participant "Drug\nModel" as DrugModel
participant "Recommended\nDrugs Model" as RecommendedModel
participant "Database" as DB

User -> ChatUI: Click "Chat with AI"
ChatUI -> ChatController: initiateChatSession(userId)
ChatController --> ChatUI: Chat session started
ChatUI --> User: Display chat interface

User -> ChatUI: Enter symptoms description
ChatUI -> ChatController: sendMessage(userId, symptoms)

ChatController -> LLM: analyzeSymptomsAndDiagnose(symptoms)
LLM -> LLM: Process medical knowledge
LLM -> LLM: Generate diagnosis
LLM -> LLM: Identify suitable medications
LLM --> ChatController: Return diagnosis and drug recommendations

ChatController -> DiagnosisModel: createDiagnosis(userId, symptoms, diagnosis)
DiagnosisModel -> DB: INSERT INTO diagnoses (user_id, symptoms, diagnosis)
DB --> DiagnosisModel: Diagnosis created
DiagnosisModel --> ChatController: Diagnosis ID

loop For each recommended drug
    ChatController -> DrugModel: findDrugByName(drugName)
    DrugModel -> DB: SELECT * FROM drugs WHERE name=?
    DB --> DrugModel: Drug data
    DrugModel --> ChatController: Drug information
    
    ChatController -> RecommendedModel: createRecommendedDrug(diagnosisId, drugId, quantity)
    RecommendedModel -> DB: INSERT INTO recommended_drugs (diagnoses_id, drug_id, quantity)
    DB --> RecommendedModel: Recommendation saved
    RecommendedModel --> ChatController: Recommendation created
end

ChatController --> ChatUI: Return diagnosis and recommendations
ChatUI --> User: Display diagnosis results

User -> ChatUI: View recommended drugs
ChatUI -> ChatController: getRecommendations(diagnosisId)
ChatController -> RecommendedModel: getRecommendationsByDiagnosis(diagnosisId)
RecommendedModel -> DB: SELECT rd.*, d.* FROM recommended_drugs rd JOIN drugs d ON rd.drug_id = d.id WHERE rd.diagnoses_id=?
DB --> RecommendedModel: Recommended drugs data
RecommendedModel --> ChatController: Recommendations with drug details
ChatController --> ChatUI: Recommendations data
ChatUI --> User: Display drug recommendations

alt User accepts all recommendations
    User -> ChatUI: Accept all recommendations
    ChatUI -> ChatController: addAllRecommendationsToCart(userId, diagnosisId)
    note right: This triggers the add to cart sequence
else User selects specific drugs
    User -> ChatUI: Select specific drugs
    ChatUI -> ChatController: addSelectedDrugsToCart(userId, selectedDrugs)
    note right: This triggers the add to cart sequence
end

@enduml
