@startuml user-registration-sequence
title User Registration Sequence Diagram

actor Guest
participant "Registration\nForm" as Form
participant "Authentication\nController" as AuthController
participant "User\nModel" as UserModel
participant "Role\nModel" as RoleModel
participant "Database" as DB
Guest -> Form: Fill registration form
Form -> Form: Validate form data
Form -> AuthController: submitRegistration(username, email, password, full_name)

AuthController -> AuthController: validateInput()
AuthController -> UserModel: checkIfUserExists(email, username)
UserModel -> DB: SELECT * FROM users WHERE email=? OR username=?
DB --> UserModel: Return query result
UserModel --> AuthController: User existence status

alt User already exists
    AuthController --> Form: Return validation error
    Form --> Guest: Display error message
else User does not exist
    AuthController -> RoleModel: getDefaultRole()
    RoleModel -> DB: SELECT * FROM roles WHERE name='user'
    DB --> RoleModel: Return default role
    RoleModel --> AuthController: Default role data
    
    AuthController -> UserModel: createUser(userData, roleId)
    UserModel -> DB: INSERT INTO users (username, email, password, role_id, full_name)
    DB --> UserModel: User created successfully
    UserModel --> AuthController: New user data
    
    AuthController --> Form: Registration successful
    Form --> Guest: Show success message
    Form -> Form: Redirect to login page
end

@enduml
